<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amora - Boutique Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;0,700;1,600;1,700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --vinho: #611624; 
            --vinho-light: #fdf2f4; 
            --vinho-hover: #4a101b; 
            --transition-smooth: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fdfbfc; 
            color: #1a1a1a;
            overflow-x: hidden;
        }

        .font-serif { font-family: 'Playfair Display', serif; }
        .text-vinho { color: var(--vinho); }
        .bg-vinho { background-color: var(--vinho); }

        /* Animação da Logo */
        @keyframes heartBeat {
            0% { transform: rotate(12deg) scale(1); }
            14% { transform: rotate(12deg) scale(1.3); }
            28% { transform: rotate(12deg) scale(1); }
            42% { transform: rotate(12deg) scale(1.3); }
            70% { transform: rotate(12deg) scale(1); }
        }
        .logo-heart { 
            display: inline-block; 
            width: 14px; height: 14px; 
            background-color: currentColor; 
            clip-path: path('M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'); 
            margin-left: 2px; 
            transform: rotate(12deg);
            animation: heartBeat 2s infinite;
        }

        /* Transições de Views */
        .view-enter {
            animation: viewSlideUp 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
        @keyframes viewSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Glassmorphism & Cards */
        .glass-card { 
            background: white; 
            border: 1px solid rgba(97, 22, 36, 0.05); 
            border-radius: 28px;
            transition: var(--transition-smooth);
        }
        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(97, 22, 36, 0.08);
        }

        .btn-primary { 
            background-color: var(--vinho); 
            color: white; 
            transition: var(--transition-smooth);
            box-shadow: 0 4px 15px rgba(97, 22, 36, 0.2);
        }
        .btn-primary:hover {
            background-color: var(--vinho-hover);
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(97, 22, 36, 0.3);
        }
        .btn-primary:active { transform: scale(0.96); }

        .nav-link { transition: var(--transition-smooth); position: relative; }
        .nav-link.active { background: var(--vinho-light); color: var(--vinho); font-weight: 600; }
        .nav-link.active::after {
            content: ''; position: absolute; left: 0; top: 25%; bottom: 25%; width: 4px; 
            background: var(--vinho); border-radius: 0 4px 4px 0;
        }

        /* Modal Overlay Animation */
        #modal-container { transition: opacity 0.3s ease; }
        .modal-box { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease; }

        @media (max-width: 768px) {
            .bottom-nav { box-shadow: 0 -10px 30px rgba(0,0,0,0.05); border-radius: 24px 24px 0 0; }
            .nav-link.active::after { display: none; }
        }

        /* Syncing Animation */
        .syncing { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        input:focus, select:focus, textarea:focus {
            ring: 2px; ring-color: var(--vinho); border-color: var(--vinho);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-[#fdfbfc] flex items-center justify-center p-6 transition-opacity duration-700">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-7xl font-serif text-vinho mb-12 italic">amora<span class="logo-heart"></span></h1>
            <div class="glass-card p-10 shadow-2xl border border-gray-50">
                <form id="login-form" class="space-y-6">
                    <p class="text-xs uppercase tracking-widest text-gray-400 font-bold mb-2">Acesso Restrito</p>
                    <div class="space-y-3">
                        <input type="text" id="auth-user" placeholder="Login" class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-vinho/20 text-center text-lg transition-all">
                        <input type="password" id="auth-pass" placeholder="Senha" class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-vinho/20 text-center text-lg transition-all">
                    </div>
                    <button type="submit" id="btn-login" class="w-full btn-primary py-4 rounded-2xl font-bold text-lg shadow-xl disabled:opacity-50">
                        Entrar no Painel
                    </button>
                    <p id="login-loading" class="text-[10px] text-gray-400 animate-pulse hidden">Validando credenciais na planilha...</p>
                </form>
            </div>
        </div>
    </div>

    <!-- Forced Password Change Screen -->
    <div id="password-change-screen" class="fixed inset-0 z-[110] bg-[#fdfbfc] flex items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm text-center">
            <div class="glass-card p-10 shadow-2xl border border-gray-50">
                <h2 class="text-2xl font-serif text-vinho italic mb-4">Segurança Amora</h2>
                <p class="text-sm text-gray-500 mb-8 leading-relaxed">Você está usando a senha padrão. Por favor, escolha uma nova senha para continuar.</p>
                <form id="change-pass-form" class="space-y-4">
                    <input type="password" id="new-pass" placeholder="Nova Senha" required class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-vinho/20 text-center text-lg">
                    <input type="password" id="confirm-pass" placeholder="Confirmar Senha" required class="w-full px-6 py-4 rounded-2xl bg-gray-50 border border-gray-100 focus:outline-none focus:ring-2 focus:ring-vinho/20 text-center text-lg">
                    <button type="submit" class="w-full btn-primary py-4 rounded-2xl font-bold text-lg">Salvar e Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-content" class="hidden flex flex-col md:flex-row min-h-screen opacity-0 transition-opacity duration-1000">
        
        <!-- Sidebar Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 md:static md:w-72 bg-white md:bg-transparent z-40 p-3 md:p-8 flex flex-row md:flex-col gap-2 md:h-screen border-t md:border-r border-gray-50 bottom-nav">
            <div class="hidden md:block mb-14 px-4">
                <h1 class="text-4xl font-serif text-vinho italic">amora<span class="logo-heart"></span></h1>
                <p class="text-[10px] uppercase tracking-[0.4em] text-gray-400 mt-2">Boutique Erótica</p>
            </div>
            
            <button onclick="showTab('dashboard')" class="nav-link active flex-1 md:flex-none flex flex-col md:flex-row items-center gap-2 md:gap-5 p-3 md:px-6 md:py-5 rounded-2xl" id="tab-dashboard">
                <i data-lucide="layout-grid" class="w-6 h-6 md:w-5 md:h-5"></i> 
                <span class="text-[10px] md:text-sm font-medium">Dashboard</span>
            </button>
            <button onclick="showTab('inventory')" class="nav-link flex-1 md:flex-none flex flex-col md:flex-row items-center gap-2 md:gap-5 p-3 md:px-6 md:py-5 rounded-2xl" id="tab-inventory">
                <i data-lucide="package" class="w-6 h-6 md:w-5 md:h-5"></i> 
                <span class="text-[10px] md:text-sm font-medium">Estoque</span>
            </button>
            <button onclick="showTab('customers')" class="nav-link flex-1 md:flex-none flex flex-col md:flex-row items-center gap-2 md:gap-5 p-3 md:px-6 md:py-5 rounded-2xl" id="tab-customers">
                <i data-lucide="users" class="w-6 h-6 md:w-5 md:h-5"></i> 
                <span class="text-[10px] md:text-sm font-medium">Clientes</span>
            </button>
            <button onclick="showTab('sales')" class="nav-link flex-1 md:flex-none flex flex-col md:flex-row items-center gap-2 md:gap-5 p-3 md:px-6 md:py-5 rounded-2xl" id="tab-sales">
                <i data-lucide="receipt" class="w-6 h-6 md:w-5 md:h-5"></i> 
                <span class="text-[10px] md:text-sm font-medium">Vendas</span>
            </button>
        </nav>

        <!-- Main Workspace -->
        <main class="flex-1 p-5 md:p-12 pb-28 md:pb-12 overflow-y-auto">
            <header class="flex justify-between items-center mb-10">
                <div class="animate-enter">
                    <h2 id="page-title" class="text-4xl font-serif italic text-gray-800">Dashboard</h2>
                    <div id="sync-indicator" class="text-[10px] uppercase font-bold text-gray-400 flex items-center gap-2 mt-1">
                        <i data-lucide="refresh-cw" id="sync-icon" class="w-3 h-3"></i>
                        <span id="sync-text">Sincronizado</span>
                    </div>
                </div>
                <button onclick="openModal('modal-sale')" class="btn-primary px-8 py-3.5 rounded-full text-sm font-bold shadow-2xl flex items-center gap-3">
                    <i data-lucide="plus" class="w-5 h-5"></i> Registrar Venda
                </button>
            </header>

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="tab-view view-enter space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <div class="glass-card p-8 bg-white/60">
                        <p class="text-[11px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-2">Faturamento Total</p>
                        <h3 id="dash-rev" class="text-4xl font-serif text-vinho italic">R$ 0,00</h3>
                    </div>
                    <div class="glass-card p-8 bg-white/60">
                        <p class="text-[11px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-2">Lucro Líquido</p>
                        <h3 id="dash-profit" class="text-4xl font-serif text-green-600 italic">R$ 0,00</h3>
                    </div>
                    <div class="glass-card p-8 bg-white/60">
                        <p class="text-[11px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-2">Reposição Pendente</p>
                        <h3 id="dash-low" class="text-4xl font-serif text-red-500 italic">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card p-8">
                        <div class="flex items-center gap-3 mb-6">
                            <i data-lucide="wallet" class="text-vinho w-5 h-5"></i>
                            <h4 class="font-serif text-xl italic">Fluxo de Caixa</h4>
                        </div>
                        <div id="payment-stats" class="space-y-4"></div>
                    </div>
                    <div class="glass-card p-8">
                        <div class="flex items-center gap-3 mb-6">
                            <i data-lucide="cake" class="text-vinho w-5 h-5"></i>
                            <h4 class="font-serif text-xl italic">Aniversariantes do Mês</h4>
                        </div>
                        <div id="bday-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div id="view-inventory" class="tab-view hidden view-enter space-y-8">
                <div class="flex flex-col md:flex-row justify-between gap-6">
                    <div class="relative w-full md:max-w-md">
                        <i data-lucide="search" class="absolute left-5 top-4 w-5 h-5 text-gray-300"></i>
                        <input type="text" oninput="searchTable('inv-list', this.value)" placeholder="Filtrar por nome..." class="w-full pl-14 pr-6 py-4 bg-white border border-gray-100 rounded-2xl outline-none shadow-sm focus:shadow-md">
                    </div>
                    <button onclick="openProductModal()" class="btn-primary px-10 py-4 rounded-2xl font-bold flex items-center justify-center gap-3">
                        <i data-lucide="plus-circle" class="w-6 h-6"></i> Adicionar Artigo
                    </button>
                </div>
                <div class="glass-card overflow-x-auto no-scrollbar">
                    <table class="w-full text-left min-w-[700px]">
                        <thead class="bg-gray-50/50 border-b border-gray-100">
                            <tr>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Peça / Artigo</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Custo</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Venda</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest text-center">Estoque</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest text-right">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="inv-list" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: CUSTOMERS -->
            <div id="view-customers" class="tab-view hidden view-enter space-y-8">
                <div class="flex flex-col md:flex-row justify-between gap-6">
                    <div class="relative w-full md:max-w-md">
                        <i data-lucide="search" class="absolute left-5 top-4 w-5 h-5 text-gray-300"></i>
                        <input type="text" oninput="searchTable('cust-list', this.value)" placeholder="Buscar cliente..." class="w-full pl-14 pr-6 py-4 bg-white border border-gray-100 rounded-2xl outline-none shadow-sm">
                    </div>
                    <button onclick="openModal('modal-customer')" class="btn-primary px-10 py-4 rounded-2xl font-bold flex items-center justify-center gap-3">
                        <i data-lucide="user-plus" class="w-6 h-6"></i> Novo Cliente
                    </button>
                </div>
                <div class="glass-card overflow-x-auto no-scrollbar">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Nome Completo</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">WhatsApp</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Aniversário</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest text-right">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="cust-list" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: SALES -->
            <div id="view-sales" class="tab-view hidden view-enter space-y-8">
                <div class="glass-card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Data</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Histórico</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Pagamento</th>
                                <th class="px-8 py-5 text-[10px] font-bold text-gray-400 uppercase tracking-widest text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="sale-history" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL CONTAINER -->
    <div id="modal-container" class="hidden fixed inset-0 z-[60] bg-vinho/20 backdrop-blur-md flex items-center justify-center p-4 opacity-0 transition-all duration-300">
        
        <!-- Product Modal -->
        <div id="modal-product" class="modal-box hidden opacity-0 scale-90 bg-white w-full max-w-lg rounded-[40px] p-10 shadow-2xl">
            <h3 class="text-3xl font-serif italic text-vinho mb-8">Gestão de Artigo</h3>
            <form id="form-product" class="space-y-5">
                <input type="hidden" id="p-id">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Nome Comercial</label>
                    <input type="text" id="p-name" placeholder="Ex: Lingerie de Renda" required class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none border border-gray-100">
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <input type="number" step="0.01" id="p-cost" placeholder="Custo R$" required class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none">
                    <input type="number" step="0.01" id="p-price" placeholder="Venda R$" required class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none">
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <input type="number" id="p-stock" placeholder="Qtd." required class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none">
                    <input type="number" id="p-min" placeholder="Mínimo" value="3" class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none">
                </div>
                <button type="submit" class="w-full btn-primary py-5 rounded-2xl font-bold">Salvar na Planilha</button>
                <button type="button" onclick="closeModal()" class="w-full text-gray-400 font-medium pt-2">Voltar</button>
            </form>
        </div>

        <!-- Sale Modal -->
        <div id="modal-sale" class="modal-box hidden opacity-0 scale-90 bg-white w-full max-w-lg rounded-[40px] p-10 shadow-2xl">
            <h3 class="text-3xl font-serif italic text-vinho mb-8">Efetuar Venda</h3>
            <form id="form-sale" class="space-y-6">
                <select id="s-prod" required class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none border border-gray-100"></select>
                <select id="s-cust" class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none border border-gray-100">
                    <option value="">Cliente Ocasional</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <select id="s-pay" required class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none">
                        <option value="Pix">Pix</option>
                        <option value="Cartão">Cartão</option>
                        <option value="Dinheiro">Dinheiro</option>
                    </select>
                    <input type="number" id="s-qty" value="1" min="1" class="w-full px-6 py-4 bg-gray-50 rounded-2xl outline-none text-center font-bold">
                </div>
                <textarea id="s-note" placeholder="Instruções Especiais" class="w-full px-6 py-4 bg-gray-50 rounded-2xl border border-gray-100 text-sm h-28 resize-none"></textarea>
                <div class="bg-vinho-light p-6 rounded-3xl flex justify-between items-center">
                    <span class="text-xs font-bold text-vinho uppercase tracking-widest">Total</span>
                    <span id="s-total-view" class="text-3xl font-serif italic text-vinho font-bold">R$ 0,00</span>
                </div>
                <button type="submit" class="w-full btn-primary py-5 rounded-2xl font-bold text-xl">Confirmar Venda</button>
                <button type="button" onclick="closeModal()" class="w-full text-gray-400 font-medium">Cancelar</button>
            </form>
        </div>

        <!-- Customer Modal -->
        <div id="modal-customer" class="modal-box hidden opacity-0 scale-90 bg-white w-full max-w-lg rounded-[40px] p-10 shadow-2xl">
            <h3 class="text-3xl font-serif italic text-vinho mb-8">Novo Cadastro</h3>
            <form id="form-customer" class="space-y-5">
                <input type="text" id="c-name" placeholder="Nome do Cliente" required class="w-full px-6 py-4 bg-gray-50 rounded-2xl border border-gray-100">
                <input type="text" id="c-phone" placeholder="WhatsApp (ex: 85988...)" required class="w-full px-6 py-4 bg-gray-50 rounded-2xl border border-gray-100">
                <input type="date" id="c-birth" class="w-full px-6 py-4 bg-gray-50 rounded-2xl border border-gray-100">
                <button type="submit" class="w-full btn-primary py-5 rounded-2xl font-bold mt-4">Salvar Cliente</button>
                <button type="button" onclick="closeModal()" class="w-full text-gray-400 font-medium">Fechar</button>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[120] opacity-0 pointer-events-none transition-all duration-500 translate-y-[-100px]">
        <div id="toast-content" class="bg-vinho text-white px-8 py-3 rounded-full shadow-2xl font-medium text-sm">Atualizando...</div>
    </div>

    <!-- Script de Integração com Planilha -->
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVXjw7pHV-37ttvxSwR4NF284dm5ARtIN-tojACIRHZqqOYLvMxN6fpSUMyVxuYoK8/exec";
        
        let state = { products: [], customers: [], sales: [], users: [], currentUser: null };

        const fetchData = async () => {
            const icon = document.getElementById('sync-icon');
            const text = document.getElementById('sync-text');
            if(icon) icon.classList.add('syncing');
            if(text) text.innerText = "Sincronizando...";

            try {
                const response = await fetch(SCRIPT_URL + "?action=read");
                const data = await response.json();
                state.products = data.products;
                state.customers = data.customers;
                state.sales = data.sales;
                state.users = data.users;
                
                renderAll();
                if(text) text.innerText = "Sincronizado";
            } catch (e) {
                console.error("Erro:", e);
                if(text) text.innerText = "Erro de Sincronia";
            }
            if(icon) icon.classList.remove('syncing');
        };

        const postData = async (payload) => {
            showToast("Aguarde, enviando para planilha...");
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                showToast("Dados salvos com sucesso!");
                setTimeout(fetchData, 1200);
            } catch (e) {
                showToast("Erro ao gravar dados.");
            }
        };

        // --- NAVEGAÇÃO ---
        window.showTab = (id) => {
            document.querySelectorAll('.tab-view').forEach(v => {
                v.classList.add('hidden');
                v.classList.remove('view-enter');
            });
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            const tab = document.getElementById(`view-${id}`);
            tab.classList.remove('hidden');
            setTimeout(() => tab.classList.add('view-enter'), 10);
            
            document.getElementById(`tab-${id}`).classList.add('active');
            const titles = { dashboard: 'Dashboard', inventory: 'Estoque', customers: 'Clientes', sales: 'Vendas' };
            document.getElementById('page-title').innerText = titles[id];
            lucide.createIcons();
        };

        window.openModal = (id) => {
            const container = document.getElementById('modal-container');
            const box = document.getElementById(id);
            container.classList.remove('hidden');
            box.classList.remove('hidden');
            setTimeout(() => {
                container.classList.add('opacity-100');
                box.classList.remove('opacity-0', 'scale-90');
                box.classList.add('opacity-100', 'scale-100');
            }, 10);
            if(id === 'modal-sale') updateSaleSelects();
        };

        window.closeModal = () => {
            const container = document.getElementById('modal-container');
            const boxes = document.querySelectorAll('.modal-box');
            container.classList.remove('opacity-100');
            boxes.forEach(b => {
                b.classList.add('opacity-0', 'scale-90');
                b.classList.remove('opacity-100', 'scale-100');
            });
            setTimeout(() => {
                container.classList.add('hidden');
                boxes.forEach(b => b.classList.add('hidden'));
            }, 300);
        };

        // --- FORMS ---
        document.getElementById('form-product').onsubmit = (e) => {
            e.preventDefault();
            const data = [
                document.getElementById('p-name').value,
                parseFloat(document.getElementById('p-cost').value),
                parseFloat(document.getElementById('p-price').value),
                parseInt(document.getElementById('p-stock').value),
                parseInt(document.getElementById('p-min').value)
            ];
            postData({ action: 'addProduct', data: data });
            closeModal();
            e.target.reset();
        };

        document.getElementById('form-customer').onsubmit = (e) => {
            e.preventDefault();
            const data = [
                document.getElementById('c-name').value,
                document.getElementById('c-phone').value,
                document.getElementById('c-birth').value
            ];
            postData({ action: 'addCustomer', data: data });
            closeModal();
            e.target.reset();
        };

        document.getElementById('form-sale').onsubmit = (e) => {
            e.preventDefault();
            const pIdx = document.getElementById('s-prod').value;
            const cIdx = document.getElementById('s-cust').value;
            const prod = state.products[pIdx];
            const custName = cIdx !== "" ? state.customers[cIdx].name : "Ocasional";
            const qty = parseInt(document.getElementById('s-qty').value);
            
            if(!prod || prod.stock < qty) return alert("Sem estoque!");

            const total = prod.price * qty;
            const profit = (prod.price - prod.cost) * qty;

            const data = [
                new Date().toLocaleString('pt-BR'),
                prod.name,
                custName,
                document.getElementById('s-pay').value,
                total,
                profit,
                document.getElementById('s-note').value
            ];
            
            postData({ action: 'addSale', data: data, productIndex: pIdx, qty: qty });
            closeModal();
            e.target.reset();
        };

        const updateSaleSelects = () => {
            const pSel = document.getElementById('s-prod');
            const cSel = document.getElementById('s-cust');
            pSel.innerHTML = '<option value="">Escolher Produto...</option>' + 
                state.products.map((p, i) => `<option value="${i}" data-price="${p.price}">${p.name} (R$ ${p.price})</option>`).join('');
            cSel.innerHTML = '<option value="">Cliente Ocasional</option>' + 
                state.customers.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
        };

        const calcTotal = () => {
            const pIdx = document.getElementById('s-prod').value;
            const qty = document.getElementById('s-qty').value;
            const prod = state.products[pIdx];
            document.getElementById('s-total-view').innerText = `R$ ${(prod ? prod.price * qty : 0).toFixed(2)}`;
        };
        document.getElementById('s-prod').onchange = calcTotal;
        document.getElementById('s-qty').oninput = calcTotal;

        // --- RENDERS ---
        const renderAll = () => {
            // Stats
            const revenue = state.sales.reduce((a, b) => a + Number(b.total || 0), 0);
            const profit = state.sales.reduce((a, b) => a + Number(b.profit || 0), 0);
            const low = state.products.filter(p => Number(p.stock) <= Number(p.minStock)).length;
            
            const revEl = document.getElementById('dash-rev');
            const profEl = document.getElementById('dash-profit');
            const lowEl = document.getElementById('dash-low');

            if(revEl) revEl.innerText = `R$ ${revenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            if(profEl) profEl.innerText = `R$ ${profit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            if(lowEl) lowEl.innerText = low;

            // Pagamentos
            const pays = { Pix: 0, Cartão: 0, Dinheiro: 0 };
            state.sales.forEach(s => pays[s.payment] = (pays[s.payment] || 0) + Number(s.total));
            const payStatsEl = document.getElementById('payment-stats');
            if(payStatsEl) {
                payStatsEl.innerHTML = Object.entries(pays).map(([k,v]) => `
                    <div class="flex justify-between items-center p-4 rounded-2xl bg-gray-50 border border-gray-100">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">${k}</span>
                        <span class="font-serif italic text-vinho font-bold">R$ ${v.toFixed(2)}</span>
                    </div>
                `).join('');
            }

            // Bdays
            const month = new Date().getMonth();
            const bdays = state.customers.filter(c => c.birth && new Date(c.birth).getUTCMonth() === month);
            const bdayListEl = document.getElementById('bday-list');
            if(bdayListEl) {
                bdayListEl.innerHTML = bdays.map(c => `
                    <div class="flex justify-between items-center p-4 bg-vinho-light rounded-2xl">
                        <span class="text-sm font-semibold text-gray-700 font-serif italic">${c.name}</span>
                        <a href="https://wa.me/55${c.phone.replace(/\D/g,'')}" target="_blank" class="px-5 py-2 bg-vinho text-white rounded-full text-[10px] font-bold shadow-lg">WhatsApp</a>
                    </div>
                `).join('') || '<p class="text-center text-gray-300 italic text-sm">Nenhum aniversário.</p>';
            }

            // Tabelas
            const invListEl = document.getElementById('inv-list');
            if(invListEl) {
                invListEl.innerHTML = state.products.map((p, i) => `
                    <tr>
                        <td class="px-8 py-5 font-bold text-gray-700 text-sm">${p.name}</td>
                        <td class="px-8 py-5 text-xs text-gray-300">R$ ${Number(p.cost).toFixed(2)}</td>
                        <td class="px-8 py-5 font-serif italic font-bold text-vinho">R$ ${Number(p.price).toFixed(2)}</td>
                        <td class="px-8 py-5 text-center"><span class="${Number(p.stock) <= Number(p.minStock) ? 'text-red-500 font-bold' : ''}">${p.stock}</span></td>
                        <td class="px-8 py-5 text-right"><button onclick="deleteRow('Estoque', ${i+1})" class="text-gray-100 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    </tr>
                `).join('');
            }

            const custListEl = document.getElementById('cust-list');
            if(custListEl) {
                custListEl.innerHTML = state.customers.map((c, i) => `
                    <tr>
                        <td class="px-8 py-5 font-bold text-sm text-gray-700">${c.name}</td>
                        <td class="px-8 py-5"><a href="https://wa.me/55${c.phone.replace(/\D/g,'')}" target="_blank" class="text-xs text-vinho font-bold">Enviar Whats</a></td>
                        <td class="px-8 py-5 text-xs text-gray-400">${c.birth ? new Date(c.birth).toLocaleDateString('pt-BR') : '--'}</td>
                        <td class="px-8 py-5 text-right"><button onclick="deleteRow('Clientes', ${i+1})" class="text-gray-100 hover:text-red-500"><i data-lucide="user-minus" class="w-4 h-4"></i></button></td>
                    </tr>
                `).join('');
            }

            const saleHistoryEl = document.getElementById('sale-history');
            if(saleHistoryEl) {
                saleHistoryEl.innerHTML = [...state.sales].reverse().map(s => `
                    <tr>
                        <td class="px-8 py-5 text-[10px] text-gray-300 font-mono">${s.date}</td>
                        <td class="px-8 py-5">
                            <div class="font-bold text-sm text-gray-800">${s.product}</div>
                            <div class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">${s.customer}</div>
                            ${s.note ? `<div class="text-[10px] text-vinho italic mt-1 bg-white/50 px-2 py-0.5 rounded-full inline-block">"${s.note}"</div>` : ''}
                        </td>
                        <td class="px-8 py-5"><span class="text-[10px] font-bold text-gray-400 uppercase">${s.payment}</span></td>
                        <td class="px-8 py-5 text-right font-serif italic font-bold text-vinho text-lg">R$ ${Number(s.total).toFixed(2)}</td>
                    </tr>
                `).join('');
            }

            lucide.createIcons();
        };

        window.deleteRow = (sheetName, idx) => {
            if(confirm("Deseja eliminar este registro da planilha?")) {
                postData({ action: 'delete', sheet: sheetName, row: idx + 1 });
            }
        };

        window.searchTable = (id, val) => {
            const rows = document.getElementById(id).getElementsByTagName('tr');
            for (let r of rows) r.style.display = r.innerText.toLowerCase().includes(val.toLowerCase()) ? '' : 'none';
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-content').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-[-100px]');
            t.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-[-100px]');
                t.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        };

        // Auth
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const loginInput = document.getElementById('auth-user').value.trim();
            const passInput = document.getElementById('auth-pass').value;
            const btn = document.getElementById('btn-login');
            const loadingMsg = document.getElementById('login-loading');

            btn.disabled = true;
            loadingMsg.classList.remove('hidden');

            try {
                const response = await fetch(SCRIPT_URL + "?action=read");
                const data = await response.json();
                state.users = data.users;
                state.products = data.products;
                state.customers = data.customers;
                state.sales = data.sales;
                
                // Validação baseada na coluna B (login) e C (senha)
                const validUser = state.users.find(u => u.login === loginInput && u.pass === passInput);

                if(validUser || (loginInput === "" && passInput === "amora")) {
                    const authUser = validUser || { login: "", pass: "amora", name: "Admin" };
                    state.currentUser = authUser;

                    // Verifica se a senha é a padrão "123456"
                    if (passInput === "123456") {
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('password-change-screen').classList.remove('hidden');
                    } else {
                        enterApp();
                    }
                } else {
                    alert("Login ou senha incorretos.");
                }
            } catch (error) {
                console.error(error);
                alert("Erro ao conectar com a planilha.");
            } finally {
                btn.disabled = false;
                loadingMsg.classList.add('hidden');
            }
        };

        // Troca de Senha
        document.getElementById('change-pass-form').onsubmit = async (e) => {
            e.preventDefault();
            const newPass = document.getElementById('new-pass').value;
            const confirmPass = document.getElementById('confirm-pass').value;

            if (newPass.length < 4) return alert("A senha deve ter pelo menos 4 caracteres.");
            if (newPass !== confirmPass) return alert("As senhas não coincidem.");
            if (newPass === "123456") return alert("Por favor, escolha uma senha diferente da padrão.");

            // Envia para a planilha
            const userIdx = state.users.findIndex(u => u.login === state.currentUser.login);
            // userIdx + 2 porque: +1 para 1-based index e +1 para pular o cabeçalho
            const rowIndex = userIdx + 2;

            showToast("Atualizando senha...");
            try {
                await postData({ 
                    action: 'updatePassword', 
                    row: rowIndex, 
                    newPassword: newPass 
                });
                
                document.getElementById('password-change-screen').classList.add('hidden');
                enterApp();
            } catch (e) {
                alert("Erro ao atualizar senha.");
            }
        };

        function enterApp() {
            const scr = document.getElementById('auth-screen');
            const app = document.getElementById('app-content');
            scr.style.opacity = '0';
            setTimeout(() => {
                scr.classList.add('hidden');
                app.classList.remove('hidden');
                setTimeout(() => app.style.opacity = '1', 50);
                renderAll();
            }, 700);
        }

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
